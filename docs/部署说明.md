# RAG系统部署说明

## 部署概述

本文档详细说明RAG智能问答系统的部署流程，包括环境准备、配置设置、启动方式等。系统支持多种部署方式，满足不同环境的需求。

## 环境要求

### 系统要求
- **操作系统**: Linux (Ubuntu 18.04+), macOS 10.15+, Windows 10+
- **Python版本**: Python 3.9 或更高版本
- **内存**: 最低 4GB，推荐 8GB+
- **存储**: 最低 10GB 可用空间
- **网络**: 需要访问互联网（用于下载模型和依赖）

### 软件依赖
- **Docker**: 20.10+ (容器化部署)
- **Docker Compose**: 2.0+ (服务编排)
- **Git**: 2.20+ (代码管理)

## 部署方式

### 方式一：直接部署（开发环境）

#### 1. 环境准备
```bash
# 检查Python版本
python3 --version

# 安装uv包管理器
pip install uv

# 克隆项目
git clone <repository-url>
cd RAG
```

#### 2. 环境配置
```bash
# 复制环境变量模板
cp env.example .env

# 编辑环境变量文件
nano .env
```

**重要配置项**：
```bash
# OpenAI API配置（必需）
OPENAI_API_KEY=your_openai_api_key_here
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-3.5-turbo

# LangSmith配置（可选，但推荐）
LANGCHAIN_TRACING_V2=true
LANGCHAIN_API_KEY=your_langsmith_api_key_here
LANGCHAIN_PROJECT=rag-system

# 向量数据库配置
VECTOR_DB_TYPE=faiss  # faiss, milvus, chroma

# 应用配置
DEBUG=true
LOG_LEVEL=INFO
```

#### 3. 安装依赖
```bash
# 使用uv安装依赖
uv sync

# 或使用pip安装
pip install -r requirements.txt
```

#### 4. 启动服务
```bash
# 使用启动脚本
chmod +x scripts/start.sh
./scripts/start.sh

# 或直接启动
uv run python -m app.main
```

#### 5. 验证部署
```bash
# 健康检查
curl http://localhost:8000/health

# 查看API文档
# 浏览器访问: http://localhost:8000/docs
```

### 方式二：Docker部署（生产环境）

#### 1. 环境准备
```bash
# 检查Docker版本
docker --version
docker-compose --version

# 克隆项目
git clone <repository-url>
cd RAG
```

#### 2. 环境配置
```bash
# 复制环境变量模板
cp env.example .env

# 编辑环境变量文件
nano .env
```

#### 3. 构建和启动
```bash
# 使用启动脚本
chmod +x scripts/docker-start.sh
./scripts/docker-start.sh

# 或手动执行
docker build -t rag-system .
docker-compose up -d
```

#### 4. 服务管理
```bash
# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f rag-app

# 停止服务
docker-compose down

# 重启服务
docker-compose restart
```

#### 5. 验证部署
```bash
# 健康检查
curl http://localhost:8000/health

# 查看服务状态
docker-compose ps
```

### 方式三：Docker Compose高级配置

#### 1. 启用Milvus向量数据库
```bash
# 启动包含Milvus的服务
docker-compose --profile milvus up -d

# 更新环境变量
echo "VECTOR_DB_TYPE=milvus" >> .env
```

#### 2. 启用Chroma向量数据库
```bash
# 启动包含Chroma的服务
docker-compose --profile chroma up -d

# 更新环境变量
echo "VECTOR_DB_TYPE=chroma" >> .env
```

#### 3. 启用Nginx反向代理
```bash
# 启动包含Nginx的服务
docker-compose --profile nginx up -d

# 配置SSL证书（可选）
mkdir -p nginx/ssl
# 将SSL证书文件放入nginx/ssl目录
```

## 配置说明

### 环境变量配置

#### 必需配置
- `OPENAI_API_KEY`: OpenAI API密钥
- `OPENAI_BASE_URL`: OpenAI API基础URL
- `OPENAI_MODEL`: 使用的LLM模型

#### 可选配置
- `LANGCHAIN_API_KEY`: LangSmith API密钥
- `VECTOR_DB_TYPE`: 向量数据库类型
- `REDIS_URL`: Redis连接URL
- `LOG_LEVEL`: 日志级别

### 向量数据库配置

#### FAISS配置
```bash
VECTOR_DB_TYPE=faiss
VECTOR_DB_PATH=./data/vector_index
```

#### Milvus配置
```bash
VECTOR_DB_TYPE=milvus
MILVUS_HOST=localhost
MILVUS_PORT=19530
MILVUS_COLLECTION=rag_documents
```

#### Chroma配置
```bash
VECTOR_DB_TYPE=chroma
CHROMA_PERSIST_DIRECTORY=./data/chroma_db
```

### 应用配置
```bash
# 文档处理配置
MAX_FILE_SIZE=10485760  # 10MB
CHUNK_SIZE=1000
CHUNK_OVERLAP=200

# 对话配置
MAX_CONVERSATION_LENGTH=10
MAX_TOKENS=4000
TEMPERATURE=0.7
```

## 数据目录结构

```
RAG/
├── data/                    # 数据目录
│   ├── uploads/            # 上传文档
│   ├── temp/               # 临时文件
│   ├── vector_index/       # FAISS索引文件
│   └── chroma_db/          # Chroma数据库文件
├── logs/                    # 日志目录
│   ├── app.log             # 应用日志
│   ├── error.log           # 错误日志
│   └── performance.log     # 性能日志
└── nginx/                   # Nginx配置（可选）
    ├── nginx.conf          # Nginx配置文件
    └── ssl/                # SSL证书目录
```

## 性能优化

### 系统级优化
```bash
# 增加文件描述符限制
echo "* soft nofile 65536" >> /etc/security/limits.conf
echo "* hard nofile 65536" >> /etc/security/limits.conf

# 优化内核参数
echo "vm.max_map_count=262144" >> /etc/sysctl.conf
sysctl -p
```

### 应用级优化
```bash
# 调整向量数据库参数
CHUNK_SIZE=500              # 减小片段大小
CHUNK_OVERLAP=100           # 减小重叠

# 调整LLM参数
MAX_TOKENS=2000             # 减少最大token数
TEMPERATURE=0.5             # 降低随机性
```

### 数据库优化
```bash
# Redis优化
redis-cli config set maxmemory 2gb
redis-cli config set maxmemory-policy allkeys-lru

# Milvus优化（如果使用）
# 在docker-compose.yml中调整参数
```

## 监控和维护

### 健康检查
```bash
# 系统健康检查
curl http://localhost:8000/health

# 详细状态检查
curl http://localhost:8000/api/v1/stats
```

### 日志管理
```bash
# 查看应用日志
tail -f logs/app.log

# 查看错误日志
tail -f logs/error.log

# 查看Docker日志
docker-compose logs -f rag-app
```

### 性能监控
```bash
# 查看系统资源使用
docker stats

# 查看API性能
curl http://localhost:8000/api/v1/stats
```

### 备份和恢复
```bash
# 备份数据目录
tar -czf rag_backup_$(date +%Y%m%d).tar.gz data/

# 备份向量索引
cp -r data/vector_index backup_vector_index

# 恢复数据
tar -xzf rag_backup_20240101.tar.gz
```

## 故障排除

### 常见问题

#### 1. 服务启动失败
```bash
# 检查端口占用
netstat -tulpn | grep 8000

# 检查日志
docker-compose logs rag-app

# 检查环境变量
docker-compose config
```

#### 2. 向量数据库连接失败
```bash
# 检查服务状态
docker-compose ps

# 检查网络连接
docker network ls
docker network inspect rag_rag-network
```

#### 3. 内存不足
```bash
# 检查内存使用
free -h

# 调整Docker内存限制
docker-compose down
docker system prune -f
docker-compose up -d
```

#### 4. 磁盘空间不足
```bash
# 检查磁盘使用
df -h

# 清理临时文件
docker system prune -f
rm -rf data/temp/*
```

### 调试模式
```bash
# 启用调试模式
echo "DEBUG=true" >> .env
echo "LOG_LEVEL=DEBUG" >> .env

# 重启服务
docker-compose restart
```

## 安全配置

### 网络安全
```bash
# 限制访问IP
# 在nginx配置中添加allow/deny规则

# 启用HTTPS
# 配置SSL证书和强制HTTPS重定向
```

### 认证授权
```bash
# 添加API密钥认证
# 在FastAPI中添加认证中间件

# 限制文件上传
# 配置文件类型和大小限制
```

### 数据安全
```bash
# 加密敏感数据
# 使用环境变量存储敏感信息

# 定期备份
# 设置自动备份脚本
```

## 扩展部署

### 负载均衡
```bash
# 使用Nginx负载均衡
# 配置多个RAG应用实例

# 使用Docker Swarm
# 部署到多个节点
```

### 高可用部署
```bash
# 数据库集群
# 配置Redis集群或Milvus集群

# 应用冗余
# 部署多个应用实例
```

### 云原生部署
```bash
# Kubernetes部署
# 创建Deployment和Service

# 云服务集成
# 使用云数据库和存储服务
```

## 总结

本文档提供了RAG系统的完整部署指南，包括多种部署方式、配置说明、性能优化、监控维护等。根据实际需求选择合适的部署方式，并按照指南进行配置和部署。

部署完成后，系统将提供完整的RAG智能问答服务，支持文档上传、向量检索、智能问答等功能。通过合理的配置和优化，系统能够满足生产环境的需求，为企业提供高质量的智能问答服务。
